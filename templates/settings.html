{% extends "base.html" %}
{% block content %}
<nav class="nav">
    <a href="{{ url_for('dashboard') }}" class="nav-brand">
        <svg viewBox="0 0 512 512" width="32" height="32">
            <defs>
                <linearGradient id="grad3" x1="0%" y1="0%" x2="0%" y2="100%">
                    <stop offset="0%" style="stop-color:#8B5CF6" />
                    <stop offset="100%" style="stop-color:#6366F1" />
                </linearGradient>
            </defs>
            <rect width="512" height="512" rx="96" fill="white"/>
            <rect x="120" y="80" width="220" height="300" rx="24" fill="url(#grad3)"/>
            <circle cx="310" cy="350" r="70" fill="#10B981"/>
            <path d="M275 350 L300 375 L355 315" fill="none" stroke="white" stroke-width="18" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        Jottask
    </a>

    <div class="nav-links">
        <a href="{{ url_for('dashboard') }}" class="nav-link">Tasks</a>
        <a href="{{ shopping_list_url }}" class="nav-link">Shopping List</a>
        <a href="{{ url_for('daily_report') }}" class="nav-link">Daily Report</a>
        <a href="{{ url_for('projects') }}" class="nav-link">Projects</a>
        <a href="{{ url_for('settings') }}" class="nav-link active">Settings</a>
    </div>

    <div class="nav-user">
        <span style="color: var(--gray-500);">{{ session.user_name }}</span>
        <div class="avatar">{{ session.user_name[0].upper() }}</div>
        <a href="{{ url_for('logout') }}" class="btn btn-secondary btn-sm">Logout</a>
    </div>
</nav>

<main class="main">
    {% if message %}
    <div class="alert alert-success">{{ message }}</div>
    {% endif %}

    <div style="display: grid; grid-template-columns: 250px 1fr; gap: 24px;">
        <!-- Sidebar -->
        <div>
            <div class="card">
                <div class="card-body" style="padding: 8px;">
                    <a href="#profile" class="nav-link active" style="display: block;">Profile</a>
                    <a href="#notifications" class="nav-link" style="display: block;">Notifications</a>
                    <a href="#email" class="nav-link" style="display: block;">Email Connection</a>
                    <a href="#crm" class="nav-link" style="display: block;">CRM Connection</a>
                    <a href="#subscription" class="nav-link" style="display: block;">Subscription</a>
                </div>
            </div>
        </div>

        <!-- Content -->
        <div>
            <!-- Profile Section -->
            <div class="card" style="margin-bottom: 24px;">
                <div class="card-header">
                    <h2 class="card-title">Profile Settings</h2>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('update_profile') }}">
                        <div class="form-group">
                            <label class="form-label">Full Name</label>
                            <input type="text" name="full_name" class="form-input" value="{{ user.full_name or '' }}">
                        </div>

                        <div class="form-group">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-input" value="{{ user.email }}" disabled>
                            <small style="color: var(--gray-500);">Contact support to change email</small>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Alternate Emails</label>
                            <input type="text" name="alternate_emails" class="form-input"
                                   value="{{ user.alternate_emails|join(', ') if user.alternate_emails else '' }}"
                                   placeholder="other@email.com, work@email.com">
                            <small style="color: var(--gray-500);">Comma-separated. Emails you send FROM that should create tasks in your account.</small>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Company Name</label>
                            <input type="text" name="company_name" class="form-input" value="{{ user.company_name or '' }}">
                        </div>

                        <div class="form-group">
                            <label class="form-label">Timezone</label>
                            <select name="timezone" class="form-input">
                                <option value="Australia/Brisbane" {% if user.timezone == 'Australia/Brisbane' %}selected{% endif %}>Australia/Brisbane (AEST)</option>
                                <option value="Australia/Sydney" {% if user.timezone == 'Australia/Sydney' %}selected{% endif %}>Australia/Sydney</option>
                                <option value="Australia/Melbourne" {% if user.timezone == 'Australia/Melbourne' %}selected{% endif %}>Australia/Melbourne</option>
                                <option value="America/New_York" {% if user.timezone == 'America/New_York' %}selected{% endif %}>US Eastern</option>
                                <option value="Europe/London" {% if user.timezone == 'Europe/London' %}selected{% endif %}>UK (GMT/BST)</option>
                            </select>
                        </div>

                        <button type="submit" class="btn btn-primary">Save Changes</button>
                    </form>
                </div>
            </div>

            <!-- Daily Summary Section -->
            <div class="card" style="margin-bottom: 24px;">
                <div class="card-header">
                    <h2 class="card-title">Daily Summary</h2>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('update_summary_settings') }}">
                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
                                <input type="checkbox" name="daily_summary_enabled" {% if user.daily_summary_enabled %}checked{% endif %} style="width: 20px; height: 20px;">
                                <span class="form-label" style="margin: 0;">Enable daily summary email</span>
                            </label>
                            <small style="color: var(--gray-500); display: block; margin-top: 8px;">
                                Receive a daily email with your tasks and projects overview
                            </small>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Summary Time</label>
                            <select name="daily_summary_time" class="form-input" style="max-width: 200px;">
                                <option value="06:00:00" {% if user.daily_summary_time == '06:00:00' %}selected{% endif %}>6:00 AM</option>
                                <option value="07:00:00" {% if user.daily_summary_time == '07:00:00' %}selected{% endif %}>7:00 AM</option>
                                <option value="08:00:00" {% if user.daily_summary_time == '08:00:00' or not user.daily_summary_time %}selected{% endif %}>8:00 AM</option>
                                <option value="09:00:00" {% if user.daily_summary_time == '09:00:00' %}selected{% endif %}>9:00 AM</option>
                            </select>
                            <small style="color: var(--gray-500);">Time in your local timezone ({{ user.timezone }})</small>
                        </div>

                        <button type="submit" class="btn btn-primary">Save Settings</button>
                    </form>
                </div>
            </div>

            <!-- CRM Connection Section -->
            <div id="crm" class="card" style="margin-bottom: 24px;">
                <div class="card-header">
                    <h2 class="card-title">CRM Connection</h2>
                </div>
                <div class="card-body">
                    {% if crm_connection %}
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div style="width: 40px; height: 40px; border-radius: 8px; background: var(--gray-100); display: flex; align-items: center; justify-content: center; font-size: 20px;">&#x1F4CA;</div>
                            <div>
                                <strong>{{ crm_connection.display_name or crm_connection.provider|capitalize }}</strong>
                                <div style="font-size: 13px; color: var(--gray-500);">
                                    {{ crm_connection.provider|capitalize }}
                                    {% if crm_connection.last_sync_at %}
                                    &bull; Last sync: {{ crm_connection.last_sync_at[:16].replace('T', ' ') }}
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <span style="padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 500;
                            {% if crm_connection.connection_status == 'connected' %}background: #D1FAE5; color: #065F46;
                            {% elif crm_connection.connection_status == 'error' %}background: #FEE2E2; color: #991B1B;
                            {% else %}background: #FEF3C7; color: #92400E;{% endif %}">
                            {{ crm_connection.connection_status|capitalize }}
                        </span>
                    </div>
                    {% if crm_connection.last_error and crm_connection.connection_status == 'error' %}
                    <p style="color: var(--danger); font-size: 13px; margin-bottom: 16px;">{{ crm_connection.last_error }}</p>
                    {% endif %}
                    <a href="{{ url_for('crm_setup.crm_setup') }}" class="btn btn-secondary">Manage CRM</a>
                    {% else %}
                    <p style="color: var(--gray-500); margin-bottom: 16px;">
                        Connect your CRM to automatically sync contact notes from email updates.
                    </p>
                    <a href="{{ url_for('crm_setup.crm_setup') }}" class="btn btn-primary">Connect CRM</a>
                    {% endif %}
                </div>
            </div>

            <!-- Subscription Section -->
            <div class="card" style="margin-bottom: 24px;">
                <div class="card-header">
                    <h2 class="card-title">Subscription</h2>
                </div>
                <div class="card-body">
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 20px;">
                        <span class="status-badge" style="background: {% if subscription.tier == 'pro' %}var(--primary){% elif subscription.tier == 'starter' %}var(--success){% else %}var(--warning){% endif %}; color: white;">
                            {{ subscription.tier|replace('_', ' ')|title }}
                        </span>
                    </div>

                    <!-- Usage Stats -->
                    <div style="background: var(--gray-50); padding: 16px; border-radius: 8px; margin-bottom: 20px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span>Tasks this month</span>
                            <strong>{{ subscription.tasks_used }} / {{ subscription.tasks_limit if subscription.tasks_limit != float('inf') else '‚àû' }}</strong>
                        </div>
                        {% if subscription.tasks_limit != float('inf') %}
                        <div style="background: var(--gray-200); height: 8px; border-radius: 4px; overflow: hidden;">
                            <div style="background: var(--primary); height: 100%; width: {{ (subscription.tasks_used / subscription.tasks_limit * 100)|int }}%; transition: width 0.3s;"></div>
                        </div>
                        {% endif %}
                    </div>

                    {% if subscription.tier == 'free_trial' %}
                    <p style="color: var(--gray-500); margin-bottom: 20px;">
                        Your trial ends on {{ user.trial_ends_at[:10] if user.trial_ends_at else 'soon' }}
                    </p>
                    {% endif %}

                    <a href="{{ url_for('pricing_page') }}" class="btn btn-primary">
                        {% if subscription.tier == 'free_trial' %}Upgrade Now{% else %}Manage Subscription{% endif %}
                    </a>
                </div>
            </div>

            <!-- Referral Section -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Refer a Friend</h2>
                </div>
                <div class="card-body">
                    <p style="color: var(--gray-600); margin-bottom: 16px;">
                        Share Jottask with friends! When they sign up and subscribe, you both get <strong>$5 credit</strong>.
                    </p>

                    <!-- Referral Link -->
                    <div style="margin-bottom: 20px;">
                        <label class="form-label">Your Referral Link</label>
                        <div style="display: flex; gap: 8px;">
                            <input type="text" id="referral-link" class="form-input" value="{{ referral_link }}" readonly style="flex: 1; background: var(--gray-50);">
                            <button onclick="copyReferralLink()" class="btn btn-secondary" style="white-space: nowrap;">
                                üìã Copy
                            </button>
                        </div>
                    </div>

                    <!-- Referral Stats -->
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px;">
                        <div style="background: var(--gray-50); padding: 16px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 24px; font-weight: 700; color: var(--primary);">{{ referral_count }}</div>
                            <div style="font-size: 13px; color: var(--gray-500);">Referrals</div>
                        </div>
                        <div style="background: var(--gray-50); padding: 16px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 24px; font-weight: 700; color: var(--success);">{{ converted_count }}</div>
                            <div style="font-size: 13px; color: var(--gray-500);">Converted</div>
                        </div>
                        <div style="background: var(--gray-50); padding: 16px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 24px; font-weight: 700; color: var(--warning);">${{ subscription.referral_credits|default(0)|round(2) }}</div>
                            <div style="font-size: 13px; color: var(--gray-500);">Credits</div>
                        </div>
                    </div>

                    <!-- Share Buttons -->
                    <div style="margin-top: 20px; display: flex; gap: 8px; flex-wrap: wrap;">
                        <a href="mailto:?subject=Try%20Jottask%20-%20AI%20Task%20Management&body=I've%20been%20using%20Jottask%20to%20manage%20my%20tasks%20via%20email.%20Check%20it%20out%3A%20{{ referral_link|urlencode }}" class="btn btn-secondary" style="flex: 1;">
                            ‚úâÔ∏è Email
                        </a>
                        <a href="https://wa.me/?text=Check%20out%20Jottask%20for%20easy%20task%20management%3A%20{{ referral_link|urlencode }}" target="_blank" class="btn btn-secondary" style="flex: 1;">
                            üí¨ WhatsApp
                        </a>
                        <a href="https://twitter.com/intent/tweet?text=Managing%20tasks%20via%20email%20with%20%40Jottask%20-%20super%20easy!&url={{ referral_link|urlencode }}" target="_blank" class="btn btn-secondary" style="flex: 1;">
                            üê¶ Twitter
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<script>
function copyReferralLink() {
    const input = document.getElementById('referral-link');
    input.select();
    document.execCommand('copy');
    alert('Referral link copied!');
}
</script>
{% endblock %}